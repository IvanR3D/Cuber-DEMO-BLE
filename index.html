<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="Rubik’s Cube">
		<meta name="keywords" content="Erno Rubik’s Cube">
		
		<link rel="stylesheet" type="text/css" href="styles/base.css">
		<link rel="icon" type="image/png" href="media/cuber-favicon-0064x0064.png">
		<link rel="apple-touch-icon" href="media/cuber-favicon-0144x0144.png">
		
		<title>Cuber</title>
		
		<style>
			#timerContainer {
				position: absolute;
				bottom: 10px;
				width: 100%;
				text-align: center;
				font-size: 50px;
				z-index: 2;
			}
			#timer {
				padding: 20px 0;
			}
			#timerButton {
				background: transparent;
				font-size: 20px;
				color: rgba(255, 255, 255, 0.3);
				border: 2px solid rgba(255, 255, 255, 0.3);
				cursor: pointer;
			}
			#timerButton {
				color: rgba(255, 255, 255);
    			border: 2px solid rgba(255, 255, 255);
			}
			#connectBtn {
				position: fixed; 
				top: 10px; 
				left: 10px; 
				background: transparent; 
				font-size: 20px; 
				color: rgba(255, 255, 255, 0.3); 
				border: 2px solid rgba(255, 255, 255, 0.3); 
				cursor: pointer;
				z-index: 1;
			}
			#connectBtn:hover {
				border: 2px solid rgba(255, 255, 255, 1);
				color: rgba(255, 255, 255, 1);
				cursor: pointer;
			}



			.popup {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.7);
				justify-content: center;
				align-items: center;
			}

			.popup-content {
				position: absolute;
				top: 40%;
    			left: 40%;
				background-color: white;
				color: black;
				padding: 20px;
				border-radius: 5px;
				text-align: center;
				box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
				z-index: 2;
			}

			* {
  box-sizing: border-box;
}

.loader-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 3;
  background-color: rgba(0, 0, 0, 0.8);
  display: none;
}

.rubik-loader {
  width: 100px;
  height: 100px;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background-image: url(https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExM2NlaTI1OTl3bHY1cXl3cW1tanNhbWxjNjc0c3ZrZzBsNDltNTczcyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/kOe46rvaOLg8smLgs5/giphy.gif);
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
}
		</style>
		<!--  Third-party frameworks and scaffolds.  -->

		<script charset="utf-8" src="scripts/vendor/three.min.js"></script>
		<script charset="utf-8" src="scripts/vendor/CSS3DRenderer.js"></script>
		<script charset="utf-8" src="scripts/vendor/SVGRenderer.js"></script>
		<script charset="utf-8" src="scripts/vendor/tween.min.js"></script>
		<script charset="utf-8" src="scripts/vendor/TrackballControls.js"></script>
		<script charset="utf-8" src="scripts/vendor/jquery.js"></script>
		<script charset="utf-8" src="scripts/vendor/skip.js"></script>		
		

		<!--  Here are the Cube guts. Enjoy.  -->

		<script charset="utf-8" src="scripts/colors.js"></script>
		<script charset="utf-8" src="scripts/directions.js"></script>
		<script charset="utf-8" src="scripts/queues.js"></script>
		<script charset="utf-8" src="scripts/twists.js"></script>
		<script charset="utf-8" src="scripts/cubelets.js"></script>
		<script charset="utf-8" src="scripts/groups.js"></script>
		<script charset="utf-8" src="scripts/slices.js"></script>
		<script charset="utf-8" src="scripts/folds.js"></script>
		<script charset="utf-8" src="scripts/cubes.js"></script>		
		<script charset="utf-8" src="scripts/solvers.js"></script>
		<script charset="utf-8" src="scripts/solvers/stewart.js"></script>		
		<script charset="utf-8" src="scripts/erno.js"></script>		
	
	</head>
	<body class="graydient">


		<div class="loader-wrapper">
			<div class="rubik-loader"></div>
		</div>

		<button id="connectBtn">Connect</button>

		<div id="timerContainer">
			<div id="timer">00:00.00</div>
			<button id="timerButton" onclick="toggleTimer()">Start Timer</button>
		</div>
		
		<div id="cubeHasTwistsQueued"></div>
		<div id="cubeIsTweening"></div>
		<div id="twist"></div>
		<div id="captions"></div>
		<div id="container"></div>
		<div id="controlsOpen">
			<div class="pad">
				<a href="." onclick="$('#controls').fadeIn( 500 );$('#controlsOpen').fadeOut( 500 );return false">Cube Control</a>
			</div>
		</div>
		<div id="controls">
			<div class="pad">

				<a id="controlsClose" class="key" href="." onclick="$('#controls').fadeOut( 500 );$('#controlsOpen').fadeIn( 500 );return false">&uarr;</a>




				<div id="presets">
					<h2>Presets</h2>
					<a href="javascript:cube.presetNormal()">Normal</a>
					<a href="javascript:cube.presetText()">Text</a>
					<a href="javascript:cube.presetWireframe()">Wireframe</a>
					<a href="javascript:cube.presetPurty()">Purty colors</a>
					<a href="javascript:cube.presetHighlightCore()">Highlight core</a>
					<a href="javascript:cube.presetHighlightCenters()">Highlight centers</a>
					<a href="javascript:cube.presetHighlightEdges()">Highlight edges</a>
					<a href="javascript:cube.presetHighlightCorners()">Highlight corners</a>
					<a href="javascript:cube.presetHighlightWhite()">Highlight white</a>
				</div>




				<div id="attributes">
					<h2>Attributes</h2>				
					<label><input type="checkbox" id="attributeFaceLabels" checked>Cube face labels</label>
					<label><input type="checkbox" id="attributePlastics"   checked>Plastic surfaces</label>
					<label><input type="checkbox" id="attributeIntroverts" checked>Introvert surfaces</label>
					<label><input type="checkbox" id="attributeStickers"   checked>Color stickers</label>
					<label><input type="checkbox" id="attributeIds"        checked>Cubelet Ids</label>
					<label><input type="checkbox" id="attributeTexts"      checked>Texts</label>
					<label><input type="checkbox" id="attributeWireframes" checked>Wireframes</label>
				</div>




				<div id="actions">
					<h2>Actions</h2>
					<a href="javascript:cube.presetDemo()">Start demo mode</a>
					<a href="javascript:cube.presetDemoStop()">Stop demo mode</a>
					<a href="javascript:cube.isShuffling=true;cube.isRotating=true;updateControls()">Start shuffle &amp; rotate</a>
					<a href="javascript:cube.isShuffling=false;cube.isRotating=false;updateControls()">Stop shuffle &amp; rotate</a>
					<a href="javascript:cube.solve()">Solve the Top Cross</a>
					<label><input type="checkbox" id="actionShuffle">Shuffle</label>
					<label><input type="checkbox" id="actionRotate">Auto rotate</label>
					<label><input type="checkbox" id="actionNotation">Show twist notation</label>
				</div>




				<div id="commands">
					<h2>Keyboard commands</h2>
					<div class="keyBundle">
						<a class="key" href="javascript:cube.twistQueue.add('X')">X</a><a class="key" href="javascript:cube.twistQueue.add('x')">x</a> whole cube<br>
						<a class="key" href="javascript:cube.twistQueue.add('L')">L</a><a class="key" href="javascript:cube.twistQueue.add('l')">l</a> left face<br>
						<a class="key" href="javascript:cube.twistQueue.add('M')">M</a><a class="key" href="javascript:cube.twistQueue.add('m')">m</a> middle slice<br>
						<a class="key" href="javascript:cube.twistQueue.add('R')">R</a><a class="key" href="javascript:cube.twistQueue.add('r')">r</a> right face<br>
					</div>
					<div class="keyBundle">
						<a class="key" href="javascript:cube.twistQueue.add('Y')">Y</a><a class="key" href="javascript:cube.twistQueue.add('y')">y</a> whole cube<br>
						<a class="key" href="javascript:cube.twistQueue.add('U')">U</a><a class="key" href="javascript:cube.twistQueue.add('u')">u</a> up face<br>
						<a class="key" href="javascript:cube.twistQueue.add('E')">E</a><a class="key" href="javascript:cube.twistQueue.add('e')">e</a> equator slice<br>
						<a class="key" href="javascript:cube.twistQueue.add('D')">D</a><a class="key" href="javascript:cube.twistQueue.add('d')">d</a> down face<br>
					</div>
					<div class="keyBundle">
						<a class="key" href="javascript:cube.twistQueue.add('Z')">Z</a><a class="key" href="javascript:cube.twistQueue.add('z')">z</a> whole cube<br>
						<a class="key" href="javascript:cube.twistQueue.add('F')">F</a><a class="key" href="javascript:cube.twistQueue.add('f')">f</a> front face<br>
						<a class="key" href="javascript:cube.twistQueue.add('S')">S</a><a class="key" href="javascript:cube.twistQueue.add('s')">s</a> standing slice<br>
						<a class="key" href="javascript:cube.twistQueue.add('B')">B</a><a class="key" href="javascript:cube.twistQueue.add('b')">b</a> back face<br>
					</div>
				</div>




				<div>
					<h2>Texts</h2>
					<textarea cols="6" rows="3" maxlength="18" wrap="hard" id="texts">BEYONDRUBIKs  CUBE</textarea>
					Hit return to or click elsewhere to apply changes.
				</div>
				<br><br>

				


			</div>
		</div>


		<!-- The Popup Container -->
		<div id="popup" class="popup">
			<div class="popup-content">
				<p>Disconnect the cube?</p>
				<button id="yesButton">Yes</button>
				<button id="noButton">No</button>
			</div>
		</div>


		<script>

			let characteristic; // Declare the characteristic in a broader scope
			let cd; // Declare the connectedDevice in a broader scope

			let connectBtn = document.getElementById("connectBtn");
			let connected = false; 


			const popup = document.getElementById("popup");
			const yesButton = document.getElementById("yesButton");
			const noButton = document.getElementById("noButton");

			// Function to change button color to green when connected
			function setButtonConnected() {
				connectBtn.innerText = "Connected";
				connectBtn.style.color = "#0a0";
				connectBtn.style.border = "2px solid #0a0";
				connected = true;
			}
			// Function to reset button color
			function resetButtonColor() {
				connectBtn.innerText = "Connect";
				connectBtn.style.color = "rgba(255, 255, 255, 0.3)";
				connectBtn.style.border = "2px solid rgba(255, 255, 255, 0.3)";
			}

			const decryptionKey = new Uint8Array([176, 81, 104, 224, 86, 137, 237, 119, 38, 26, 193, 161, 210, 126, 150, 81, 93, 13, 236, 249, 89, 235, 88, 24, 113, 81, 214, 131, 130, 199, 2, 169, 39, 165, 171, 41]);
			const solvedState = new Uint8Array([0x12,0x34,0x56,0x78,0x33,0x33,0x33,0x33,0x12,0x34,0x56,0x78,0x9a,0xbc,0x00,0x00]);

const isEncrypted = (data) => {
	return data[18].toString(16) === 'a7';
};

/*const toBin = (dec) => {
  return (dec >>> 0).toString(2);
};*/

const getNibble = (val, i) => {
  if(i % 2 === 1) {
    return val[(i/2)|0] % 16;
  }
  return 0|(val[(i/2)|0] / 16);
};

const decrypt = (data) => {
	if(!isEncrypted(data)) return data;
	let offset1 = getNibble(data, 38);
  let offset2 = getNibble(data, 39);
	for (let i=0; i<20; i++) {
		// Apply the offset to each value in the data
		data[i] += (decryptionKey[offset1 + i] + decryptionKey[offset2 + i]);
	}
	return data;
};

const getMove = (data) => {
	let lastMoveFace = getNibble(data, 32);
  let lastMoveDirection = getNibble(data, 33);
	// for white side facing user, with red on top
	let faceNames = ["L", "B", "D", "F", "U", "R"];
	
	return `${faceNames[lastMoveFace-1]}${lastMoveDirection === 1 ? '' : '\''}`;
};

const getState = (data) => {
	let state = '';
	for(let i=0; i<16; i++){
		state += data[i].toString(16);
	}
	return state;
};


    // Helper functions and constants (similar to React hooks)
    let device = null;

    function setDevice(connectedDevice) {
      device = connectedDevice;
    }

    function useEffect(callback) {
      // This implementation ignores the dependency array for simplicity
      // A more advanced implementation should handle dependencies.
      callback();
    }

    // The rest of the code remains the same as the React code

    // Constants
    const SERVICE_UUID = '0000aadb-0000-1000-8000-00805f9b34fb';
    const CHARACTERISTIC_UUID = '0000aadc-0000-1000-8000-00805f9b34fb';

    const isWebBluetoothSupported = 'bluetooth' in navigator;

    const connectToBluetoothDevice = () => {
      return navigator.bluetooth
        .requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID],
        })
        .then((device) =>
          device.gatt.connect().then((server) => {
            window.mdevice = device;
            window.mserver = server;
            return { device, server };
          })
        );
    };

    const startNotifications = (server) =>
      server.getPrimaryService(SERVICE_UUID).then((service) => {
        window.mservice = service;
        return service.getCharacteristic(CHARACTERISTIC_UUID).then((characteristic) => {
          window.mcharacteristic = characteristic;
          characteristic.startNotifications();
          return characteristic;
        });
      });

    const disconnectFromBluetoothDevice = (device) => {
      if (!device || !device.gatt.connected) return Promise.resolve();
      return device.gatt.disconnect();
    };

    // Event listener function for the "Connect" button
    const onClickHandler = async () => {
      // a quick check for bluetooth support in the browser
      if (!isWebBluetoothSupported) {
        alert('Browser does not support bluetooth');
        return;
      }

	  if (!connected) {
		try {
			const { server, device: connectedDevice } = await connectToBluetoothDevice();
			document.getElementsByClassName("loader-wrapper")[0].style.display = "block";
			cd = connectedDevice;
			setDevice(connectedDevice);

			characteristic = await startNotifications(server);
			setButtonConnected(); 
			document.getElementsByClassName("loader-wrapper")[0].style.display = "none";
			characteristic.addEventListener('characteristicvaluechanged', (event) => {
				const { value } = event.target; // 20 bytes sent by the cube
				const uint8array = decrypt(new Uint8Array(value.buffer));
				const state = getState(uint8array);
				console.log(state);
				console.log(`Move: ${getMove(uint8array)}`);
				switch (getMove(uint8array)) {
					case "R":
						cube.twistQueue.add('R');
						break;
					case "R'":
						cube.twistQueue.add('r');
						break;
					case "L":
						cube.twistQueue.add('L');
						break;
					case "L'":
						cube.twistQueue.add('l');
						break;
					case "U":
						cube.twistQueue.add('U');
						break;
					case "U'":
						cube.twistQueue.add('u');
						break;
					case "D":
						cube.twistQueue.add('D');
						break;
					case "D'":
						cube.twistQueue.add('d');
						break;
					case "F":
						cube.twistQueue.add('F');
						break;
					case "F'":
						cube.twistQueue.add('f');
						break;
					case "B":
						cube.twistQueue.add('B');
						break;
					case "B'":
						cube.twistQueue.add('b');
						break;
					default:
						break;
				}
			});

			connectedDevice.addEventListener('gattserverdisconnected', () => {
				disconnectFromBluetoothDevice(connectedDevice);
				resetButtonColor();
			});
		} catch (error) {
			console.error('Error:', error);
			resetButtonColor();
		}
	  } else {
		popup.style.display = "block";
	  }
      
    };

    // Add the event listener to the "Connect" button
    document.getElementById('connectBtn').addEventListener('click', onClickHandler);

yesButton.addEventListener("click", () => {
    // Disconnect the cube and set the connected variable to false
	disconnectFromBluetoothDevice(cd);
	resetButtonColor();
	characteristic = null; // Clear the characteristic reference
	cd = null; // Clear the connectedDevice reference
    // Close the popup
    popup.style.display = "none";
});

noButton.addEventListener("click", () => {
    // Simply close the popup without disconnecting the cube
    popup.style.display = "none";
});







/* TIMER */
	
	let timerInterval;
	let startTime;
	let countdownInterval;
	let countdownSeconds = 15;
	let timerRunning = false; 
	let countdownRunning = false;

	// Function to start the countdown before timer
	function startCountdown() {
		countdownRunning = true;
		countdownSeconds = 15; // Reset countdown duration
		countdownInterval = setInterval(updateCountdown, 1000); // Update countdown every second
		document.getElementById("timer").textContent = countdownSeconds; // Display initial countdown value
		document.getElementById("timerButton").textContent = "Inspection";
	}
	// Function to update the countdown display
	function updateCountdown() {
		countdownSeconds--;
		if (countdownSeconds === 0) {
			clearInterval(countdownInterval);
			startTimer(); // Start the timer after countdown
		} else {
			document.getElementById("timer").textContent = countdownSeconds;
		}
	}
	// Function to start the timer
	function startTimer() {
		startTime = Date.now();
		timerInterval = setInterval(updateTimer, 10); // Update timer every 10 milliseconds
		timerRunning = true;
		document.getElementById("timerButton").textContent = "Stop Timer";
	}
	// Function to stop the timer
	function stopTimer() {
		clearInterval(timerInterval);
		timerRunning = false;
		document.getElementById("timerButton").textContent = "Start Timer";
	}
	// Function to toggle the timer start/stop
	function toggleTimer() {
		
		if (!countdownRunning && !timerRunning) {
			startCountdown();
		}
		else if (countdownRunning && !timerRunning) {
			clearInterval(countdownInterval);
			countdownRunning = false;
			startTimer();
		} else {
			stopTimer();
		}
	}
	// Function to update the timer display
	function updateTimer() {
		if (cube.isSolved()) {
			stopTimer();
		}
		var currentTime = Date.now();
		var elapsedTime = currentTime - startTime; // Time in milliseconds
		var minutes = Math.floor(elapsedTime / (1000 * 60));
		var seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);
		var milliseconds = elapsedTime % 1000;
		document.getElementById("timer").textContent = `${minutes}:${seconds < 10 ? "0" : ""}${seconds}.${milliseconds < 100 ? (milliseconds < 10 ? "00" : "0") : ""}${milliseconds}`;
	}
	// Add your existing event listener for the space key
	document.addEventListener("keyup", function(event) {
		if (event.key === " ") { // Space key
			toggleTimer();
		}
	});
	
		</script>
	</body>
</html>